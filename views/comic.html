<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{title}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-black min-h-screen flex items-center justify-center">
    <div class="w-full h-full relative">
      <div class="w-full h-full flex items-center justify-center">
        <img
          id="comicImage"
          src=""
          alt="comic"
          class="select-none fit-vertical"
        />
      </div>

      <button
        id="prevBtn"
        class="absolute left-0 top-0 bottom-0 w-1/4 outline-none"
      ></button>

      <button
        id="nextBtn"
        class="absolute right-0 top-0 bottom-0 w-1/4 outline-none"
      ></button>
    </div>

    <script>
      const images = JSON.parse("{{imagesJson}}") || [];
      const startIndex = Number("{{startIndex}}") || 0;
      let idx = startIndex;

      const imgEl = document.getElementById("comicImage");
      const posEl = document.getElementById("position");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      function show(index) {
        if (!images || images.length === 0) return;
        if (index < 0) index = 0;
        if (index >= images.length) index = images.length - 1;

        idx = index;
        imgEl.src = images[idx];

        // 预加载相邻图片
        if (images[idx + 1]) new Image().src = images[idx + 1];
        if (images[idx - 1]) new Image().src = images[idx - 1];
      }

      function next() {
        show(Math.min(images.length - 1, idx + 1));
      }

      function prev() {
        show(Math.max(0, idx - 1));
      }

      prevBtn.addEventListener("click", (e) => {
        e.preventDefault();
        prev();
      });

      nextBtn.addEventListener("click", (e) => {
        e.preventDefault();
        next();
      });

      window.addEventListener("keydown", (e) => {
        if (e.key === "ArrowRight" || e.key === "PageDown") next();
        if (e.key === "ArrowLeft" || e.key === "PageUp") prev();
        if (e.key === "Home") show(0);
        if (e.key === "End") show(images.length - 1);
      });

      // 触摸事件
      let touchStartX = 0;
      window.addEventListener("touchstart", (e) => {
        touchStartX = e.touches[0].clientX;
      });
      window.addEventListener("touchend", (e) => {
        const diff = e.changedTouches[0].clientX - touchStartX;
        // 判断滑动距离是否足够触发翻页
        if (Math.abs(diff) > 50) {
          if (diff < 0) next();
          else prev();
        }
      });

      // 图片点击事件
      imgEl.addEventListener("click", (e) => {
        const w = imgEl.getBoundingClientRect().width;
        const clickX = e.clientX - imgEl.getBoundingClientRect().left;
        if (clickX / w > 0.6) next();
        else if (clickX / w < 0.4) prev();
      });

      show(idx);
    </script>
    <style>
      img.fit-vertical {
        height: calc(100vh - 6rem);
        width: auto;
        max-width: 100%;
        object-fit: contain;
      }

      #imageWrap {
        padding: 0 2rem;
        height: calc(100vh - 4rem);
        box-sizing: border-box;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>
  </body>
</html>

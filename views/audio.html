<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{title}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex justify-center items-center">
    <div class="p-6 flex min-w-[50%vw]">
      <div
        class="rounded-xl shadow-lg overflow-hidden grid grid-cols-1 md:grid-cols-2 gap-0"
      >
        <!-- 播放控制区域 -->
        <div
          class="md:col-span-1 p-6 flex justify-center items-center flex-col items-center gap-4"
        >
          <!-- 音轨信息显示区域 -->
          <div class="w-full text-center text-gray-600">
            <div id="trackTitle" class="font-semibold text-lg truncate"></div>
            <div id="trackIndex" class="text-sm mt-1">0 / 0</div>
          </div>

          <!-- 进度条和控制按钮区域 -->
          <div class="w-full">
            <!-- 进度条容器 -->
            <div id="progressContainer" class="w-full mb-4">
              <!-- 时间显示区域 -->
              <div class="flex items-center justify-between text-sm mb-2">
                <div id="time">00:00</div>
                <div id="duration">--:--</div>
              </div>
              <!-- 进度条 -->
              <div
                id="progressArea"
                class="relative h-3 bg-gray-200 rounded overflow-hidden cursor-pointer"
                aria-label="进度条"
              >
                <!-- 进度条已播放部分 -->
                <div
                  id="progressBar"
                  class="absolute left-0 top-0 h-3 bg-gray-300"
                  style="width: 0%"
                ></div>
                <!-- 进度条拖动点 -->
                <div
                  id="thumb"
                  class="absolute top-1/2 -translate-y-1/2 left-0 w-4 h-4 bg-white rounded-full shadow transform -translate-x-1/2 opacity-90"
                  style="left: 0%"
                ></div>
              </div>
            </div>

            <!-- 控制按钮区域 -->
            <div class="flex items-center justify-center gap-6">
              <!-- 上一首按钮 -->
              <button
                id="prev"
                title="上一首"
                class="p-2 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 transition ease-in-out"
              >
                <
              </button>

              <!-- 播放/暂停按钮 -->
              <button
                id="playPause"
                title="播放/暂停"
                class="p-2 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 transition ease-in-out"
              >
                <!-- 播放图标 -->
                <svg
                  id="playIcon"
                  class="w-7 h-7"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path d="M5 3v18l15-9L5 3z" />
                </svg>
                <!-- 暂停图标 -->
                <svg
                  id="pauseIcon"
                  class="w-7 h-7 hidden"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path d="M6 19h4V5H6v14zM14 5v14h4V5h-4z" />
                </svg>
              </button>

              <!-- 下一首按钮 -->
              <button
                id="next"
                title="下一首"
                class="p-2 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 transition ease-in-out"
              >
                >
              </button>
            </div>
          </div>
        </div>

        <!-- 播放列表区域 -->
        <div class="md:col-span-1 p-4">
          <!-- 播放列表标题 -->
          <div class="flex items-center justify-between mb-4">
            <div class="text-sm text-gray-600">播放列表</div>
          </div>
          <!-- 播放列表容器 -->
          <div id="playlist" class="overflow-auto max-h-[60vh] p-2"></div>
        </div>
      </div>
    </div>

    <!-- 音频播放元素 -->
    <audio id="player" preload="metadata"></audio>

    <script>
      const audios = JSON.parse("{{audioJson}}") || [];
      const startIndex = Number("{{startIndex}}") || 0;
      let idx = startIndex;

      const player = document.getElementById("player");
      const playPauseBtn = document.getElementById("playPause");
      const prevBtn = document.getElementById("prev");
      const nextBtn = document.getElementById("next");
      const timeEl = document.getElementById("time");
      const trackTitle = document.getElementById("trackTitle");
      const trackIndex = document.getElementById("trackIndex");
      const playlistEl = document.getElementById("playlist");
      const progressBar = document.getElementById("progressBar");
      const playIcon = document.getElementById("playIcon");
      const pauseIcon = document.getElementById("pauseIcon");

      // 唤醒锁和保存定时器变量
      let wakeLock = null;
      let saveTimer = null;

      /**
       * 格式化时间为 mm:ss 格式
       * @param {number} s - 秒数
       * @returns {string} 格式化后的时间字符串
       */
      function formatTime(s) {
        if (!isFinite(s)) return "00:00";
        const m = Math.floor(s / 60)
          .toString()
          .padStart(2, "0");
        const ss = Math.floor(s % 60)
          .toString()
          .padStart(2, "0");
        return `${m}:${ss}`;
      }

      /**
       * 保存当前播放位置到本地存储
       */
      function savePosition() {
        try {
          const key = "audio_pos_" + encodeURIComponent(audios[idx] || "");
          const data = { t: player.currentTime, idx };
          localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {}
      }

      /**
       * 从本地存储恢复指定索引音频的播放位置
       * @param {number} i - 音频索引
       * @returns {number} 保存的播放位置（秒）
       */
      function restorePositionForIndex(i) {
        try {
          const key = "audio_pos_" + encodeURIComponent(audios[i] || "");
          const raw = localStorage.getItem(key);
          if (!raw) return 0;
          const obj = JSON.parse(raw);
          if (obj && typeof obj.t === "number") return obj.t;
        } catch (e) {}
        return 0;
      }

      /**
       * 请求屏幕唤醒锁以防止屏幕自动关闭
       * @returns {Promise<void>}
       */
      async function requestWakeLock() {
        try {
          if ("wakeLock" in navigator) {
            wakeLock = await navigator.wakeLock.request("screen");
            wakeLock.addEventListener("release", () => {});
          }
        } catch (e) {}
      }

      /**
       * 释放屏幕唤醒锁
       */
      function releaseWakeLock() {
        try {
          if (wakeLock) {
            wakeLock.release();
            wakeLock = null;
          }
        } catch (e) {}
      }

      /**
       * 构建播放列表
       */
      function buildPlaylist() {
        playlistEl.innerHTML = "";
        audios.forEach((src, i) => {
          const name = decodeURIComponent(src);
          const item = document.createElement("div");
          item.className =
            "p-3 rounded cursor-pointer flex items-center gap-3 border-2 border-transparent border-solid rounded-lg";
          item.dataset.idx = String(i);
          item.innerHTML = `
            <div class="w-10 text-center text-sm text-gray-600">${i + 1}</div>
            <div class="flex-1 min-w-0">
              <div class="truncate text-gray-600 truncate">${name}</div>
            </div>
          `;
          item.addEventListener("click", () => {
            loadIndex(i, true);
          });
          playlistEl.appendChild(item);
        });
        highlightCurrent();
      }

      /**
       * 高亮显示当前播放的音轨
       */
      function highlightCurrent() {
        Array.from(playlistEl.children).forEach((c) => {
          c.classList.remove("border-gray-400");
          c.classList.add("border-transparent");
        });
        const cur = playlistEl.querySelector(`[data-idx='${idx}']`);
        if (cur) {
          cur.classList.add("border-gray-400");
          cur.classList.remove("border-transparent");
        }
      }

      /**
       * 加载指定索引的音频
       * @param {number} i - 音频索引
       * @param {boolean} autoplay - 是否自动播放
       */
      function loadIndex(i, autoplay = false) {
        if (!audios || audios.length === 0) return;
        if (i < 0) i = 0;
        if (i >= audios.length) i = audios.length - 1;

        try {
          savePosition();
        } catch (e) {}

        // 更新当前索引和音频源
        idx = i;
        const src = audios[idx];
        player.src = src;
        trackTitle.innerHTML = decodeURIComponent(src);
        trackIndex.textContent = `${idx + 1} / ${audios.length}`;

        // 恢复播放位置
        const pos = restorePositionForIndex(idx);
        player.currentTime = Math.max(0, pos || 0);
        highlightCurrent();

        // 如果需要自动播放则开始播放
        if (autoplay) player.play().catch(() => {});
      }

      // 为播放/暂停按钮添加点击事件监听器
      playPauseBtn.addEventListener("click", () => {
        if (player.paused) player.play();
        else player.pause();
      });

      prevBtn.addEventListener("click", () => {
        loadIndex(idx - 1, true);
      });

      nextBtn.addEventListener("click", () => {
        loadIndex(idx + 1, true);
      });

      player.addEventListener("play", async () => {
        playIcon.classList.add("hidden");
        pauseIcon.classList.remove("hidden");
        try {
          await requestWakeLock();
        } catch (e) {}
      });

      player.addEventListener("pause", () => {
        playIcon.classList.remove("hidden");
        pauseIcon.classList.add("hidden");
        try {
          releaseWakeLock();
        } catch (e) {}
      });

      // 为时间更新事件添加监听器
      player.addEventListener("timeupdate", () => {
        const cur = player.currentTime || 0;
        const dur = player.duration || 0;
        timeEl.textContent = `${formatTime(cur)}`;
        document.getElementById("duration").textContent =
          isFinite(dur) && dur > 0 ? formatTime(dur) : "--:--";

        // 更新进度条显示
        if (isFinite(dur) && dur > 0) {
          const pct = Math.min(100, Math.floor((cur / dur) * 100));
          progressBar.style.width = pct + "%";
          const thumbEl = document.getElementById("thumb");
          if (thumbEl) thumbEl.style.left = pct + "%";
        }

        // 定时保存播放位置
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(savePosition, 1000);
      });

      // 为加载进度事件添加监听器
      player.addEventListener("progress", () => {
        try {
          const buffered = player.buffered;
          if (buffered.length) {
            const end = buffered.end(buffered.length - 1);
            const dur = player.duration || 1;
            const pct = Math.min(100, Math.floor((end / dur) * 100));
          }
        } catch (e) {}
      });

      // 为播放结束事件添加监听器
      player.addEventListener("ended", () => {
        if (idx < audios.length - 1) loadIndex(idx + 1, true);
        else {
          player.pause();
        }
      });

      // 为进度条添加点击事件监听器
      const progressArea = document.getElementById("progressArea");
      if (progressArea) {
        progressArea.addEventListener("click", (e) => {
          const rect = progressArea.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const pct = Math.max(0, Math.min(1, x / rect.width));
          const dur = player.duration || 0;
          if (isFinite(dur) && dur > 0) player.currentTime = pct * dur;
        });
      }

      // 添加键盘事件监听器
      window.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
          e.preventDefault();
          if (player.paused) player.play();
          else player.pause();
        } else if (e.key === "ArrowLeft") {
          loadIndex(idx - 1, true);
        } else if (e.key === "ArrowRight") {
          loadIndex(idx + 1, true);
        }
      });

      // 添加页面可见性变化事件监听器
      document.addEventListener("visibilitychange", async () => {
        if (document.visibilityState === "visible" && !player.paused)
          try {
            await requestWakeLock();
          } catch (e) {}
      });

      // 添加页面卸载前事件监听器
      window.addEventListener("beforeunload", () => {
        try {
          savePosition();
        } catch (e) {}
        try {
          releaseWakeLock();
        } catch (e) {}
      });

      // 初始化播放器
      try {
        if (audios && audios.length > 0) {
          buildPlaylist();
          loadIndex(idx, false);
        } else {
          playlistEl.innerHTML =
            '<div class="text-gray-500 p-4">未找到音频文件</div>';
        }
      } catch (e) {}
    </script>
  </body>
</html>

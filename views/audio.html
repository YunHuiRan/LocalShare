<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{title}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex justify-center items-center">
    <div class="max-w-6xl mx-auto p-6 flex">
      <div
        class="rounded-xl shadow-lg overflow-hidden grid grid-cols-1 md:grid-cols-2 gap-0"
      >
        <!-- Player (left) -->
        <div
          class="md:col-span-1 p-6 flex justify-center items-center flex-col items-center gap-4"
        >
          <div class="w-full text-center text-gray-600">
            <div id="trackTitle" class="font-semibold text-lg truncate"></div>
            <div id="trackIndex" class="text-sm mt-1">0 / 0</div>
          </div>

          <div class="w-full">
            <!-- Large independent progress area -->
            <div id="progressContainer" class="w-full mb-4">
              <div class="flex items-center justify-between text-sm mb-2">
                <div id="time">00:00</div>
                <div id="duration">--:--</div>
              </div>
              <div
                id="progressArea"
                class="relative h-3 bg-gray-200 rounded overflow-hidden cursor-pointer"
                aria-label="进度条"
              >
                <div
                  id="bufferBar"
                  class="absolute left-0 top-0 h-3 bg-gray-300 rounded"
                  style="width: 0%"
                ></div>
                <div
                  id="progressBar"
                  class="absolute left-0 top-0 h-3 bg-gray-400"
                  style="width: 0%"
                ></div>
                <div
                  id="thumb"
                  class="absolute top-1/2 -translate-y-1/2 left-0 w-4 h-4 bg-white rounded-full shadow transform -translate-x-1/2 opacity-90"
                  style="left: 0%"
                ></div>
              </div>
            </div>

            <div class="flex items-center justify-center gap-6">
              <button
                id="prev"
                title="上一首"
                class="p-2 rounded-full bg-gray-400 hover:bg-gray-500 transition ease-in-out"
              >
                <
              </button>

              <button
                id="playPause"
                title="播放/暂停"
                class="p-2 rounded-full bg-gray-400 hover:bg-gray-500 transition ease-in-out"
              >
                <svg
                  id="playIcon"
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-7 h-7"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path d="M5 3v18l15-9L5 3z" />
                </svg>
                <svg
                  id="pauseIcon"
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-7 h-7 hidden"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path d="M6 19h4V5H6v14zM14 5v14h4V5h-4z" />
                </svg>
              </button>

              <button
                id="next"
                title="下一首"
                class="p-2 rounded-full bg-gray-400 hover:bg-gray-500 transition ease-in-out"
              >
                >
              </button>
            </div>

            <div class="mt-3 flex items-center justify-center">
              <label class="text-xs text-gray-600 mr-2">倍速</label>
              <select
                id="rate"
                class="bg-gray-400 text-white rounded px-2 py-1 text-sm outline-none transition ease-in-out hover:bg-gray-500"
              >
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1" selected>1x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
              </select>
            </div>
          </div>
        </div>

        <div class="md:col-span-1 p-4">
          <div class="flex items-center justify-between mb-4">
            <div class="text-sm text-gray-600">播放列表</div>
          </div>
          <div id="playlist" class="overflow-auto max-h-[60vh] p-2"></div>
        </div>
      </div>
    </div>

    <audio id="player" preload="metadata"></audio>

    <script>
      const audios = JSON.parse("{{audioJson}}") || [];
      const startIndex = Number("{{startIndex}}") || 0;
      let idx = startIndex;

      const player = document.getElementById("player");
      const playPauseBtn = document.getElementById("playPause");
      const prevBtn = document.getElementById("prev");
      const nextBtn = document.getElementById("next");
      const rateSel = document.getElementById("rate");
      const timeEl = document.getElementById("time");
      const trackTitle = document.getElementById("trackTitle");
      const trackIndex = document.getElementById("trackIndex");
      const playlistEl = document.getElementById("playlist");
      const progressBar = document.getElementById("progressBar");
      const bufferBar = document.getElementById("bufferBar");
      const playIcon = document.getElementById("playIcon");
      const pauseIcon = document.getElementById("pauseIcon");

      let wakeLock = null;
      let saveTimer = null;

      function formatTime(s) {
        if (!isFinite(s)) return "00:00";
        const m = Math.floor(s / 60)
          .toString()
          .padStart(2, "0");
        const ss = Math.floor(s % 60)
          .toString()
          .padStart(2, "0");
        return `${m}:${ss}`;
      }

      function savePosition() {
        try {
          const key = "audio_pos_" + encodeURIComponent(audios[idx] || "");
          const data = { t: player.currentTime, idx };
          localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {}
      }

      function restorePositionForIndex(i) {
        try {
          const key = "audio_pos_" + encodeURIComponent(audios[i] || "");
          const raw = localStorage.getItem(key);
          if (!raw) return 0;
          const obj = JSON.parse(raw);
          if (obj && typeof obj.t === "number") return obj.t;
        } catch (e) {}
        return 0;
      }

      async function requestWakeLock() {
        try {
          if ("wakeLock" in navigator) {
            wakeLock = await navigator.wakeLock.request("screen");
            // keep wakeLock reference; no visible UI update per user preference
            wakeLock.addEventListener("release", () => {
              // released
            });
          }
        } catch (e) {
          // ignore errors silently
        }
      }

      function releaseWakeLock() {
        try {
          if (wakeLock) {
            wakeLock.release();
            wakeLock = null;
          }
        } catch (e) {}
      }

      function buildPlaylist() {
        playlistEl.innerHTML = "";
        audios.forEach((src, i) => {
          const name = decodeURIComponent(src);
          const item = document.createElement("div");
          item.className =
            "p-3 rounded cursor-pointer flex items-center gap-3 border-2 border-transparent border-solid rounded-lg";
          item.dataset.idx = String(i);
          item.innerHTML = `
            <div class="w-10 text-center text-sm text-gray-400">${i + 1}</div>
            <div class="flex-1 min-w-0">
              <div class="truncate text-gray-400 truncate">${name
                .split(".")[1]}</div>
            </div>
          `;
          item.addEventListener("click", () => {
            loadIndex(i, true);
          });
          playlistEl.appendChild(item);
        });
        highlightCurrent();
      }

      function highlightCurrent() {
        Array.from(playlistEl.children).forEach((c) => {
          c.classList.remove("border-gray-400");
          c.classList.add("border-transparent");
        });
        const cur = playlistEl.querySelector(`[data-idx='${idx}']`);
        if (cur) {
          cur.classList.add("border-gray-400");
          cur.classList.remove("border-transparent");
        }
      }

      function loadIndex(i, autoplay = false) {
        if (!audios || audios.length === 0) return;
        if (i < 0) i = 0;
        if (i >= audios.length) i = audios.length - 1;
        try {
          savePosition();
        } catch (e) {}
        idx = i;
        const src = audios[idx];
        player.src = src;
        trackTitle.innerHTML = decodeURIComponent(src.split(".")[1]);
        trackIndex.textContent = `${idx + 1} / ${audios.length}`;
        const pos = restorePositionForIndex(idx);
        player.currentTime = Math.max(0, pos || 0);
        highlightCurrent();
        if (autoplay) player.play().catch(() => {});
      }

      // controls
      playPauseBtn.addEventListener("click", () => {
        if (player.paused) player.play();
        else player.pause();
      });
      // NOTE: swap next/prev handlers to match expected button positions
      prevBtn.addEventListener("click", () => {
        // previous -> go to previous index
        loadIndex(idx - 1, true);
      });
      nextBtn.addEventListener("click", () => {
        // next -> go to next index
        loadIndex(idx + 1, true);
      });

      rateSel.addEventListener("change", () => {
        player.playbackRate = Number(rateSel.value) || 1;
      });

      player.addEventListener("play", async () => {
        playIcon.classList.add("hidden");
        pauseIcon.classList.remove("hidden");
        try {
          await requestWakeLock();
        } catch (e) {}
      });
      player.addEventListener("pause", () => {
        playIcon.classList.remove("hidden");
        pauseIcon.classList.add("hidden");
        try {
          releaseWakeLock();
        } catch (e) {}
      });

      player.addEventListener("timeupdate", () => {
        const cur = player.currentTime || 0;
        const dur = player.duration || 0;
        timeEl.textContent = `${formatTime(cur)}`;
        document.getElementById("duration").textContent =
          isFinite(dur) && dur > 0 ? formatTime(dur) : "--:--";
        if (isFinite(dur) && dur > 0) {
          const pct = Math.min(100, Math.floor((cur / dur) * 100));
          progressBar.style.width = pct + "%";
          // move thumb
          const thumbEl = document.getElementById("thumb");
          if (thumbEl) thumbEl.style.left = pct + "%";
        }
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(savePosition, 1000);
      });

      player.addEventListener("progress", () => {
        try {
          const buffered = player.buffered;
          if (buffered.length) {
            const end = buffered.end(buffered.length - 1);
            const dur = player.duration || 1;
            const pct = Math.min(100, Math.floor((end / dur) * 100));
            bufferBar.style.width = pct + "%";
          }
        } catch (e) {}
      });

      player.addEventListener("ended", () => {
        if (idx < audios.length - 1) loadIndex(idx + 1, true);
        else {
          player.pause();
        }
      });

      // click on progress area to seek
      const progressArea = document.getElementById("progressArea");
      if (progressArea) {
        progressArea.addEventListener("click", (e) => {
          const rect = progressArea.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const pct = Math.max(0, Math.min(1, x / rect.width));
          const dur = player.duration || 0;
          if (isFinite(dur) && dur > 0) player.currentTime = pct * dur;
        });
      }

      // keyboard
      window.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
          e.preventDefault();
          if (player.paused) player.play();
          else player.pause();
        } else if (e.key === "ArrowLeft") {
          loadIndex(idx - 1, true);
        } else if (e.key === "ArrowRight") {
          loadIndex(idx + 1, true);
        }
      });

      document.addEventListener("visibilitychange", async () => {
        if (document.visibilityState === "visible" && !player.paused)
          try {
            await requestWakeLock();
          } catch (e) {}
      });

      window.addEventListener("beforeunload", () => {
        try {
          savePosition();
        } catch (e) {}
        try {
          releaseWakeLock();
        } catch (e) {}
      });

      // init
      try {
        if (audios && audios.length > 0) {
          buildPlaylist();
          player.playbackRate = Number(rateSel.value) || 1;
          loadIndex(idx, false);
        } else {
          playlistEl.innerHTML =
            '<div class="text-gray-500 p-4">未找到音频文件</div>';
        }
      } catch (e) {}
    </script>
  </body>
</html>
